generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Order {
  trackingNumber    String   @id
  brandId           String   @default("default")
  courier           String   @default("PostEx")
  orderRefNumber    String
  invoicePayment    Float
  customerName      String
  customerPhone     String
  deliveryAddress   String
  transactionDate   String
  orderDetail       String
  orderType         String
  orderDate         String
  orderAmount       Float
  orderStatus       String
  transactionStatus String
  cityName          String?

  // New fields from Track Delivery
  transactionTax    Float?
  transactionFee    Float?
  upfrontPayment    Float?
  actualWeight      Float?
  lastStatus        String?
  lastStatusTime    DateTime?
  reversalTax       Float?
  reversalFee       Float?
  salesWithholdingTax Float?
  netAmount         Float?

  trackingStatus    TrackingStatus?
  paymentStatus     PaymentStatus?

  lastFetchedAt DateTime @default(now())

  @@index([brandId, orderDate])
  @@index([brandId, courier])
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  passwordHash  String
  name          String
  role          UserRole     @default(USER)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  brands        Brand[]
  brandAccess   UserBrand[]
}

model UserBrand {
  id        String   @id @default(cuid())
  userId    String
  brandId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, brandId])
  @@index([userId])
  @@index([brandId])
}

model Brand {
  id                   String  @id @default(cuid())
  name                 String
  userId               String?
  user                 User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiToken             String  @default("")
  tranzoToken          String  @default("")
  tranzoApiToken       String  @default("")
  proxyUrl             String  @default("")
  shopifyStore          String  @default("")
  shopifyAccessToken    String  @default("")
  shopifyClientId       String  @default("")
  shopifyClientSecret   String  @default("")
  postexMerchantId     String  @default("")
  postexMerchantToken  String  @default("")
  tranzoMerchantToken  String  @default("")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  userAccess           UserBrand[]

  @@index([userId])
}

model ShopifyOrder {
  shopifyOrderId    String   @id
  brandId           String
  orderNumber       String
  orderName         String
  email             String   @default("")
  customerName      String   @default("")
  createdAt         String
  financialStatus   String   @default("")
  fulfillmentStatus String   @default("")
  totalPrice        Float    @default(0)
  currency          String   @default("PKR")
  lineItems         String   @default("[]")
  fulfillments      String   @default("[]")
  trackingNumbers   String   @default("[]")
  courierPartner    String   @default("")
  phone             String   @default("")
  shippingAddress   String   @default("")
  shippingCity      String   @default("")
  tags              String   @default("")
  pendingRemark     String   @default("")
  lastFetchedAt     DateTime @default(now())

  @@index([brandId, createdAt])
}

model PostexCpr {
  cprId             Int      @id
  brandId           String
  merchantId        String   @default("")
  merchantName      String   @default("")
  cprNumber         String   @default("")
  statusId          Int      @default(0)
  status            String   @default("")
  netAmount         Float    @default(0)
  createDatetime    String   @default("")
  approveDate       String   @default("")
  lastFetchedAt     DateTime @default(now())

  @@index([brandId])
  @@index([brandId, createDatetime])
}

model TranzoInvoice {
  id                Int      @id @default(autoincrement())
  invoiceId         Int
  brandId           String
  invoiceNumber     String   @default("")
  invoiceType       String   @default("")
  merchant          String   @default("")
  merchantStore     String?
  totalOrders       Int      @default(0)
  netAmount         Float    @default(0)
  invoiceStatus     String   @default("")
  createdAt         String   @default("")
  createdBy         String   @default("")
  approvedAt        String?
  approvedBy        String?
  holdAt            String?
  holdBy            String?
  settledAt         String?
  settledBy         String?
  disputedAt        String?
  disputedBy        String?
  lastFetchedAt     DateTime @default(now())

  @@unique([brandId, invoiceId])
  @@index([brandId])
  @@index([brandId, createdAt])
}

model WhatsAppContact {
  id            String   @id @default(cuid())
  waId          String
  profileName   String   @default("")
  phoneNumber   String   @default("")
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  messages      WhatsAppMessage[]

  @@unique([waId])
  @@index([phoneNumber])
  @@index([lastMessageAt])
}

model WhatsAppMessage {
  id            String   @id @default(cuid())
  messageId     String   @unique
  contactId     String
  contact       WhatsAppContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  direction     String
  type          String   @default("text")
  body          String   @default("")
  mediaUrl      String   @default("")
  mediaType     String   @default("")
  timestamp     DateTime
  status        String   @default("")
  contextMsgId  String?
  metadata      String   @default("{}")
  createdAt     DateTime @default(now())

  @@index([contactId, timestamp])
  @@index([direction])
  @@index([type])
  @@index([timestamp])
}

model TrackingStatus {
  trackingNumber String @id
  data           String // JSON string
  updatedAt      DateTime @updatedAt
  
  order          Order    @relation(fields: [trackingNumber], references: [trackingNumber], onDelete: Cascade)
}

model PaymentStatus {
  trackingNumber String @id
  data           String // JSON string
  updatedAt      DateTime @updatedAt
  
  order          Order    @relation(fields: [trackingNumber], references: [trackingNumber], onDelete: Cascade)
}
