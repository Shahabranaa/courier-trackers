generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL") // Connection pool / Accelerate
  directUrl = env("POSTGRES_URL")        // Direct connection for migrations
}

model Order {
  trackingNumber    String   @id
  brandId           String   @default("default")
  courier           String   @default("PostEx")
  orderRefNumber    String
  invoicePayment    Float
  customerName      String
  customerPhone     String
  deliveryAddress   String
  transactionDate   String
  orderDetail       String
  orderType         String
  orderDate         String
  orderAmount       Float
  orderStatus       String
  transactionStatus String
  cityName          String?

  // New fields from Track Delivery
  transactionTax    Float?
  transactionFee    Float?
  upfrontPayment    Float?
  actualWeight      Float?
  lastStatus        String?
  lastStatusTime    DateTime?
  reversalTax       Float?
  reversalFee       Float?
  salesWithholdingTax Float?
  netAmount         Float?

  trackingStatus    TrackingStatus?
  paymentStatus     PaymentStatus?

  lastFetchedAt DateTime @default(now())

  @@index([brandId, orderDate])
  @@index([brandId, courier])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

model User {
  id           String      @id @default(cuid())
  username     String      @unique
  passwordHash String
  displayName  String      @default("")
  role         UserRole    @default(USER)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  sessions     Session[]
  userBrands   UserBrand[]
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model UserBrand {
  id      String @id @default(cuid())
  userId  String
  brandId String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@index([userId])
  @@index([brandId])
}

model Brand {
  id                   String      @id @default(cuid())
  name                 String
  apiToken             String      @default("")
  tranzoToken          String      @default("")
  proxyUrl             String      @default("")
  shopifyStore          String      @default("")
  shopifyAccessToken    String      @default("")
  shopifyClientId       String      @default("")
  shopifyClientSecret   String      @default("")
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  userBrands           UserBrand[]
}

model ShopifyOrder {
  shopifyOrderId    String   @id
  brandId           String
  orderNumber       String
  orderName         String
  email             String   @default("")
  customerName      String   @default("")
  createdAt         String
  financialStatus   String   @default("")
  fulfillmentStatus String   @default("")
  totalPrice        Float    @default(0)
  currency          String   @default("PKR")
  lineItems         String   @default("[]")
  fulfillments      String   @default("[]")
  trackingNumbers   String   @default("[]")
  courierPartner    String   @default("")
  phone             String   @default("")
  shippingAddress   String   @default("")
  shippingCity      String   @default("")
  tags              String   @default("")
  pendingRemark     String   @default("")
  lastFetchedAt     DateTime @default(now())

  @@index([brandId, createdAt])
}

model TrackingStatus {
  trackingNumber String @id
  data           String // JSON string
  updatedAt      DateTime @updatedAt
  
  order          Order    @relation(fields: [trackingNumber], references: [trackingNumber], onDelete: Cascade)
}

model PaymentStatus {
  trackingNumber String @id
  data           String // JSON string
  updatedAt      DateTime @updatedAt
  
  order          Order    @relation(fields: [trackingNumber], references: [trackingNumber], onDelete: Cascade)
}
